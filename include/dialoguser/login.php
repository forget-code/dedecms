<?
require_once(dirname(__FILE__)."/../config_base.php");
require_once(dirname(__FILE__)."/../include/inc_memberlogin.php");
if(empty($dopost)) $dopost="";
//--------------------------------
//登录检测
//--------------------------------
if($dopost=="login")
{
 	 $svali = GetCookie("dd_ckstr");
   if(strtolower($vdcode)!=$svali && $svali!=""){
  	 ShowMsg("验证码错误！","-1");
  	 exit();
   }
   if(ereg("[ '\"\*\?\%]","",$userid)||ereg("[ '\"\*\?\%]","",$pwd)){
   	 ShowMsg("用户名或密码不合法！","-1",0,2000);
  	 exit();
   }
   if($userid==""||$pwd==""){
   	 ShowMsg("用户名或密码不能为空！","-1",0,2000);
  	 exit();
   }
   //检查帐号
   $rs = $cfg_ml->CheckUser($userid,$pwd);
   if($rs==0) {
   	 ShowMsg("用户名不存在！","-1",0,2000);
  	 exit();
   }
   else if($rs==-1){
   	 ShowMsg("密码错误！","-1",0,2000);
  	 exit();
   }
   else{
   	 $dsql = new DedeSql(false);
   	 $dsql->SetQuery("update #@__member set logintime='".mytime()."',loginip='".GetIP()."' where ID='".$cfg_ml->M_ID."'");
   	 $dsql->ExecuteNoneQuery();
   	 $dsql->Close();
   	 if(!empty($gotopage)){
		     ShowMsg("成功登录，正在转向...",$gotopage);
		     exit();
		  }else{
		     ShowMsg("成功登录，请关闭本窗口后开启一个新窗口！","javascript:;");
		     exit();
		 }
  	 exit();
   }
}
?>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>织梦内容管理系统 DedeCms V3</title>
<link href="base.css" rel="stylesheet" type="text/css">
</head>
<body style='MARGIN: 0px' bgColor='#ffffff' leftMargin='0' topMargin='0' scroll='no'>
<table width="98%" border="0" align="center" cellpadding="0" cellspacing="0" bordercolor="#111111" style="BORDER-COLLAPSE: collapse">
  <tr> 
    <td width="100%" height="64" background="img/indextitlebg.gif"><img src="img/indextitle.gif" width="250" height="64"> 
    </td>
  </tr>
  <tr> 
    <td width="100%" height="20">　</td>
  </tr>
  <tr> 
    <td width="100%" height="20" valign="bottom">
    	<table width="540" border="0" cellspacing="0" cellpadding="0">
        <tr> 
          <td align="right" style="FONT-SIZE: 2pt">&nbsp;</td>
        </tr>
        <tr> 
          <td><IMG height=14 src="img/book1.gif" width=20>&nbsp; 用户登录</td>
        </tr>
      </table></td>
  </tr>
  <tr> 
    <td width="100%" height="1" background="img/sp_bg.gif"></td>
  </tr>
  <tr> 
    <td width="100%" height="2"></td>
  </tr>
  <tr> 
    <td width="100%" height="136" valign="top">
    	<form name="form1" method="post" action="login.php">
        <input type="hidden" name="gotopage" value="<?if(!empty($gotopage)) echo $gotopage;?>">
        <input type="hidden" name="dopost" value="login">
        <table width="540" border="0" cellspacing="0" cellpadding="0">
          <tr> 
            <td colspan="2" height="4"></td>
          </tr>
          <tr> 
            <td width="156" height="30" align="center"> 用户名：</td>
            <td width="384"> <input type="text" name="userid" style="width:150;height:20"> 
            </td>
          </tr>
          <tr> 
            <td height="30" align="center"> 密　码： </td>
            <td> <input type="password" name="pwd" style="width:150;height:20"> 
            </td>
          </tr>
          <tr> 
            <td height="30" align="center"> 验证码： </td>
            <td> <table width="90%"  border="0" cellspacing="0" cellpadding="0">
                <tr> 
                  <td width="25%"><input type="text" name="vdcode" style="width:80;height:20"></td>
                  <td width="75%"><img src='../vdimgck.php' width='50' height='20'></td>
                </tr>
              </table></td>
          </tr>
          <tr> 
            <td height="50" colspan="2" align="center">
            	<input type="submit" name="sm1" value="登录" style="background-color:#BAE171;border:1px solid #666666" onClick="this.form.submit();"> 
              &nbsp;
              <input type="button" name="sm2" value="Power by DedeCms" onClick="window.open('http://www.dedecms.com');" style="background-color:#FFFFFF;border:1px solid #DDDDDD;color:#DDDDDD"> 
              &nbsp;
              </td>
          </tr>
        </table>
      </form></td>
  </tr>
  <tr> 
    <td width="100%" height="2" valign="top"></td>
  </tr>
</table>
</body>
</html>
